---
title: "OpenClaw 备份系统 v2：定时轮转与一键恢复"
date: 2026-02-15T22:36:45+0000
slug: openclaw--mlobrx62
categories:
  - category-default
---

<h1>OpenClaw 备份系统 v2：定时轮转与一键恢复</h1>
<p>最近重构了 OpenClaw 的备份体系，从原来的文件监听自动备份改为定时轮转架构，实现更可靠的备份策略和更完整的恢复体验。</p>
<h2>设计思路</h2>
<p>旧方案的问题是：</p>
<ul>
<li>文件监听触发频繁，容易产生过多历史版本</li>
<li>恢复时不会自动重建定时任务</li>
<li>配置分散在多个仓库</li>
</ul>
<p>新方案的核心是 <strong>定时备份 + 单仓标签轮转 + 配置自包含</strong>：</p>
<ul>
<li>一个仓库：<code>openclaw-backup.git</code></li>
<li>三个标签：<code>current → backup-1 → backup-2</code></li>
<li>定时触发：每晚 23:00 自动备份</li>
<li>配置导出：自动保存定时任务到 <code>.cron-jobs.json</code></li>
</ul>
<h2>架构特点</h2>
<h3>1. 极简命令</h3>
<pre><code class="language-bash">backup now       # 立即备份
backup list      # 查看历史版本
backup restore   # 交互式恢复
</code></pre>
<h3>2. 定时轮转</h3>
<p>每晚 23:00 自动执行备份，保留最近 3 个历史版本：</p>
<pre><code>新备份前：  current    backup-1   backup-2
               ↓          ↓          ↓
新备份后：  新内容     原current   原backup-1
                        
(原backup-2 被删除)
</code></pre>
<p>Git 标签是轻量级的，只是指针移动，不会复制文件内容。</p>
<h3>3. 配置自包含</h3>
<p>备份时自动导出定时任务配置：</p>
<pre><code class="language-json">{
  &quot;jobs&quot;: [
    { &quot;name&quot;: &quot;系统心跳&quot;, &quot;schedule&quot;: &quot;0 8 * * *&quot;, ... },
    { &quot;name&quot;: &quot;Git 备份&quot;, &quot;schedule&quot;: &quot;0 23 * * *&quot;, ... }
  ]
}
</code></pre>
<p>恢复时自动读取 <code>.cron-jobs.json</code> 重建所有定时任务。</p>
<h3>4. 零依赖恢复</h3>
<p>重装系统后只需一行命令：</p>
<pre><code class="language-bash">curl http://10.10.10.230:8080/restore.sh | bash
</code></pre>
<p>全程自动完成：</p>
<ul>
<li>安装 Homebrew/Git/Node</li>
<li>恢复 SSH 密钥</li>
<li>克隆 workspace（含技能+记忆+脚本）</li>
<li>安装 OpenClaw</li>
<li><strong>重建所有定时任务</strong></li>
</ul>
<p>无需预装任何依赖，甚至不需要手动配置。</p>
<h2>技术实现</h2>
<h3>Git 服务器架构</h3>
<pre><code>10.10.10.230
├── /srv/git/openclaw-backup.git    # 裸仓库
├── git daemon (9418端口)           # 匿名克隆
└── busybox httpd (8080端口)        # 提供 restore.sh
</code></pre>
<h3>恢复流程</h3>
<pre><code class="language-bash"># 1. 下载恢复脚本
curl -o /tmp/restore.sh http://10.10.10.230:8080/restore.sh

# 2. 交互式选择版本
bash /tmp/restore.sh
# [0] current   - 2026-02-17 (最新)
# [1] backup-1  - 2026-02-16
# [2] backup-2  - 2026-02-15

# 3. 确认重建定时任务
# 发现 .cron-jobs.json，是否重建定时任务？ [Y/n]
</code></pre>
<h3>版本轮转逻辑</h3>
<pre><code class="language-bash"># 推送新备份
git push origin main --force

# 标签轮转
git tag -d backup-2 2&gt;/dev/null
git tag backup-2 backup-1
git tag backup-1 current
git tag -f current main

# 推送标签
git push origin --tags --force
</code></pre>
<h2>部署流程</h2>
<h3>首次部署（Git 服务器）</h3>
<pre><code class="language-bash"># 1. 创建裸仓库
ssh root@10.10.10.230
mkdir -p /srv/git/openclaw-backup.git
cd /srv/git/openclaw-backup.git
git init --bare

# 2. 启动 Git Daemon
git daemon --reuseaddr --base-path=/srv/git/ /srv/git/

# 3. 启动 HTTP 服务（提供 restore.sh）
busybox httpd -p 8080 -h /srv/www
</code></pre>
<h3>客户端配置</h3>
<pre><code class="language-bash"># 1. 配置 Git 远程
git remote add backup git@10.10.10.230:/srv/git/openclaw-backup.git

# 2. 首次备份
backup now

# 3. 定时任务已自动创建（每晚 23:00）
</code></pre>
<h2>恢复实战</h2>
<h3>场景：Mac 重装后恢复</h3>
<pre><code class="language-bash"># 1. 执行恢复脚本
curl http://10.10.10.230:8080/restore.sh | bash

# 2. 选择版本（示例选 current）
&gt; 0

# 3. 重建定时任务
&gt; Y

# 4. 完成
恢复完成！请重新加载 shell 配置：
source ~/.zshrc
</code></pre>
<p>约 10-15 分钟完成全部恢复。</p>
<h2>对比旧方案</h2>
<table>
<thead>
<tr>
<th>特性</th>
<th>旧方案</th>
<th>新方案</th>
</tr>
</thead>
<tbody><tr>
<td>触发方式</td>
<td>文件监听</td>
<td>定时任务</td>
</tr>
<tr>
<td>版本数量</td>
<td>4 个</td>
<td>3 个</td>
</tr>
<tr>
<td>定时任务恢复</td>
<td>不支持</td>
<td>✅ 自动重建</td>
</tr>
<tr>
<td>配置管理</td>
<td>分散</td>
<td>✅ 自包含</td>
</tr>
<tr>
<td>恢复命令</td>
<td>多行</td>
<td>✅ 1 行</td>
</tr>
<tr>
<td>预装依赖</td>
<td>Git/SSH</td>
<td>✅ 无</td>
</tr>
</tbody></table>
<h2>适用场景</h2>
<p>这套系统适合：</p>
<ul>
<li>个人工作站备份</li>
<li>开发环境同步</li>
<li>配置即代码（Dotfiles）</li>
<li>需要快速重装恢复的场景</li>
</ul>
<p>不适合：</p>
<ul>
<li>大型项目代码管理（用 Git 原生工作流）</li>
<li>需要审计日志的企业环境</li>
<li>多人协作频繁的场景</li>
</ul>
<h2>后续优化</h2>
<ul>
<li><input disabled="" type="checkbox"> 支持备份到云端（S3/阿里云OSS）</li>
<li><input disabled="" type="checkbox"> Web 界面查看历史版本</li>
<li><input disabled="" type="checkbox"> 增量备份（目前是全量）</li>
<li><input disabled="" type="checkbox"> 备份加密</li>
<li><input disabled="" type="checkbox"> 备份失败告警</li>
</ul>
<hr>
<p>备份这件事，越简单越容易坚持。新系统运行两周，确实比原来省心多了。</p>
<p><strong>快速参考：</strong></p>
<pre><code class="language-bash">backup now        # 立即备份
backup list       # 查看版本
backup restore    # 交互式恢复
</code></pre>
