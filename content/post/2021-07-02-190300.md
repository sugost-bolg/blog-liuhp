---
title: 电报代理mtproxy+tls实现对流量的伪装并采用白名单模式来应对防火墙的检测
date: 2021-07-02T19:03:00+08:00
lastmod: 2021-07-02T19:03:00+08:00
draft: false
categories: 
- 电脑网络

tags: []
description: 
slug: 145
aliases: 
- /archives/145

---

\n该镜像集成了nginx、mtproxy+tls 实现对流量的伪装，并采用白名单模式来应对防火墙的检测。
Installation
Centos7上安装docker\n\n
\nDocker从1.13版本之后采用时间线的方式作为版本号，分为社区版CE和企业版EE。\n\n
\n社区版是免费提供给个人开发者和小型团体使用的，企业版会提供额外的收费服务，比如经过官方测试认证过的基础设施、容器、插件等。\n\n
\n社区版按照stable和edge两种方式发布，每个季度更新stable版本，如17.06，17.09；每个月份更新edge版本，如17.09，17.10。\n\n
\n一、安装docker
1、Docker 要求 CentOS 系统的内核版本高于 3.10 ，查看本页面的前提条件来验证你的CentOS 版本是否支持 Docker 。\n\n
\n通过 uname -r 命令查看你当前的内核版本\n\n
\n$ uname -r
2、使用 root 权限登录 Centos。确保 yum 包更新到最新。\n\n
\n$ sudo yum update
3、卸载旧版本(如果安装过旧版本的话)\n\n
\n$ sudo yum remove docker  docker-common docker-selinux docker-engine
4、安装需要的软件包， yum-util 提供yum-config-manager功能，另外两个是devicemapper驱动依赖的\n\n
\n$ sudo yum install -y yum-utils device-mapper-persistent-data lvm2
5、设置yum源\n\n
\n$ sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n\n
\n6、可以查看所有仓库中所有docker版本，并选择特定版本安装\n\n
\n$ yum list docker-ce --showduplicates | sort -r\n\n
\n7、安装docker\n\n
\n$ sudo yum install docker-ce  #由于repo中默认只开启stable仓库，故这里安装的是最新稳定版17.12.0
$ sudo yum install   # 例如：sudo yum install docker-ce-17.12.0.ce\n\n
\n8、启动并加入开机启动\n\n
\n$ sudo systemctl start docker
$ sudo systemctl enable docker
9、验证安装是否成功(有client和service两部分表示docker安装启动都成功了)\n\n
\n$ docker version\n\n
\n二、问题
1、因为之前已经安装过旧版本的docker，在安装的时候报错如下：\n\n
\nTransaction check error:
file /usr/bin/docker from install of docker-ce-17.12.0.ce-1.el7.centos.x86_64 conflicts with file from package docker-common-2:1.12.6-68.gitec8512b.el7.centos.x86_64
file /usr/bin/docker-containerd from install of docker-ce-17.12.0.ce-1.el7.centos.x86_64 conflicts with file from package docker-common-2:1.12.6-68.gitec8512b.el7.centos.x86_64
file /usr/bin/docker-containerd-shim from install of docker-ce-17.12.0.ce-1.el7.centos.x86_64 conflicts with file from package docker-common-2:1.12.6-68.gitec8512b.el7.centos.x86_64
file /usr/bin/dockerd from install of docker-ce-17.12.0.ce-1.el7.centos.x86_64 conflicts with file from package docker-common-2:1.12.6-68.gitec8512b.el7.centos.x86_64\n\n
\n2、卸载旧版本的包\n\n
\n$ sudo yum erase docker-common-2:1.12.6-68.gitec8512b.el7.centos.x86_64\n\n
\n3、再次安装docker\n\n
\n$ sudo yum install docker-ce\n\n
\n卸载 docker
删除安装包：
yum remove docker-ce\n\n
\n删除镜像、容器、配置文件等内容：
rm -rf /var/lib/docker\n\n

---

\nPull images\n\n
\ndocker pull ellermister/nginx-mtproxy:latest\n\n
\nQuickly create MTProxy\n\n
\n可通过 -p 指定端口映射，连接均为外部端口。\n\n
\ndocker run --name nginx-mtproxy -d  -p 80:80 -p 443:443 ellermister/nginx-mtproxy:latest\n\n
\nCustom parameters\n\n
\n你可以在创建时指定 secret、tag、 domain：\n\n
\nsecret=$(head -c 16 /dev/urandom | xxd -ps)
tag="12345678901234567890121231231231"
domain="cloudflare.com"
docker run --name nginx-mtproxy -d -e tag="$tag" -e secret="$secret" -e domain="$domain" -p 80:80 -p 443:443 ellermister/nginx-mtproxy:latest\n\n
\n创建完毕后，查看访问链接：\n\n
\ndocker logs nginx-mtproxy\n\n
\n注意：请注意修改端口为你的 docker 映射的端口。\n\n
\nUsage
The image uses a whitelist mode to fight crawling and firewall detection.\n\n
\n该镜像采用白名单模式，来应对爬虫和防火墙探测。\n\n
\nwhitelist
By default, all visitors are not allowed to connect. Only when the visitor tries to access the address below, the guest IP will be added to the whitelist.\n\n
\nThe IP and port depend on your docker configuration:\n\n
\n默认所有访客都不被允许连接，只有当访客尝试访问了下面的地址，才会将访客IP加入到白名单中。\n\n
\nIP 和端口取决于你 docker 的配置：\n\n
\nhttp://ip/add.php\n\n
\nservice Stop service / 停止服务\n\n
\ndocker stop nginx-mtproxy\n\n
\nStart service / 启动服务\n\n
\ndocker start nginx-mtproxy\n\n
\nRestart service / 重启服务\n\n
\ndocker restart nginx-mtproxy\n\n
\nDelete service / 删除服务\n\n
\ndocker rm nginx-mtproxy\n\n
\nAuto Run /  开机自启\n\n
\ndocker update --restart=always nginx-mtproxy\n\n
\n