---
title: 修复 OpenClaw 本地语义搜索：从 404 到完整配置管理
date: 2026-02-15T19:28:28.380000+08:00
lastmod: 2026-02-15T19:28:28.380000+08:00
draft: false
categories: 
- develop

tags: []
description: 
slug: -openclaw-404--mlnnwhqm
aliases: 
- /archives/-openclaw-404--mlnnwhqm

---

\n# 修复 OpenClaw 本地语义搜索：从 404 到完整配置管理\n\n
\n> \n> 2026-02-15 | 技术折腾\n> \n> \n\n
\n今天把 OpenClaw 的语义搜索从「完全不能用」修到了「带版本管理的完整方案」，记录一下过程。\n\n

---

\n## 问题现象\n\n
\n调用 `memory_search` 工具时报错：\n\n
\n```\n`openai embeddings failed: 404 Not found
`\n```\n
\n检查发现：\n\n

- 本地 Embedding API 服务（端口 3001）运行正常\n
- 但 OpenClaw 的请求发到了 OpenAI 官方 API\n
- 因为没配置 API key，直接返回 404\n

---

\n## 修复过程\n\n
\n### 1. 配置本地 Embedding Provider\n\n
\n在 `openclaw.json` 中添加本地 provider：\n\n
\n```\n`"models": {
  "providers": {
    "openai": {
      "baseUrl": "http://localhost:3001",
      "apiKey": "local-key",
      "api": "openai-completions",
      "models": [
        {
          "id": "text-embedding-ada-002",
          "name": "Local Embedding"
        }
      ]
    }
  }
}
`\n```\n
\n### 2. 解决 Auth 配置\n\n
\nOpenClaw 要求 auth 必须存储在单独文件，创建：\n\n
\n```\n`// ~/.openclaw/agents/main/agent/auth-profiles.json
{
  "profiles": {
    "openai:default": {
      "provider": "openai",
      "apiKey": "sk-local1234567890"
    }
  }
}
`\n```\n
\n### 3. 修复路径不匹配\n\n
\n本地服务只监听了 `/v1/embeddings`，但 OpenClaw 请求的是 `/embeddings`。\n\n
\n修改 `local-embedding-api.mjs`：\n\n
\n```\n`if ((url.pathname === '/v1/embeddings' || url.pathname === '/embeddings') && req.method === 'POST') {
  // ...
}
`\n```\n
\n### 4. 验证结果\n\n
\n```\n`$ openclaw memory status
Memory Search (main)
Provider: openai (requested: openai)
Model: text-embedding-3-small
Indexed: 11/11 files · 24 chunks
Vector: ready
Vector dims: 384
`\n```\n
\n搜索测试：\n\n
\n```\n`$ memory_search "Git 服务器配置"
✅ 返回 3 条相关结果，最高相关度 0.59
`\n```\n

---

\n## 配置管理系统\n\n
\n防止 Git 实时备份把错误配置也同步进去，建立版本管理机制：\n\n
\n### 目录结构\n\n
\n```\n`configs/
├── version-manager.sh          # 版本管理器
├── restore-openclaw-config.sh  # 重装恢复脚本
├── openclaw.json              # 最新配置
├── auth-profiles.json         # 最新认证
└── versions/                   # 版本历史（最多5个）
    ├── v1/
    │   ├── openclaw.json
    │   ├── auth-profiles.json
    │   ├── TIMESTAMP.txt
    │   ├── GIT_COMMIT.txt
    │   └── DESCRIPTION.txt
    └── v2/
        └── ...
`\n```\n
\n### 使用方式\n\n
\n保存稳定版本（配置正常后）：\n\n
\n```\n`bash version-manager.sh save "语义模型正常工作"
`\n```\n
\n查看版本历史：\n\n
\n```\n`bash version-manager.sh list
`\n```\n
\n回滚到指定版本：\n\n
\n```\n`bash version-manager.sh restore v1
`\n```\n
\n重装后恢复：\n\n
\n```\n`bash restore-openclaw-config.sh
# 交互式选择要恢复的版本
`\n```\n

---

\n## 技术细节\n\n
\n||\n||\n||\n||\n||\n||\n||\n\n

---

\n## 总结\n\n
\n现在 OpenClaw 的语义搜索：\n\n

- ✅ 使用本地模型，无需 OpenAI API\n
- ✅ 配置有多版本管理，可回滚\n
- ✅ 重装后可一键恢复\n
- ✅ 自动备份到私有 Git 服务器\n

\n下一步：考虑把 Embedding 服务也做成系统服务，开机自启。\n\n

---

\n参考链接:\n\n

- OpenClaw 文档: [https://docs.openclaw.ai](https://docs.openclaw.ai)\n
- 本地模型: [https://huggingface.co/Xenova/all-MiniLM-L6-v2](https://huggingface.co/Xenova/all-MiniLM-L6-v2)\n
\n