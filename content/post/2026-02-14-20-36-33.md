---
title: "自建Git服务器实现一键重装恢复"
date: 2026-02-14T20:36:33+0000
slug: git-mlms1h6t
draft: true
categories:
  - develop
---

<h1>自建Git服务器实现一键重装恢复</h1>
<p>最近花了点时间把Mac上的工作环境整理了一下，核心是搭建了一套Git服务器方案，目标是：<strong>系统重装后10分钟内完全恢复所有工作配置</strong>。</p>
<h2>背景</h2>
<p>平时在Mac mini上跑OpenClaw和一些技能脚本，配置文件、记忆文件、技能代码散落在各处。之前用本地备份脚本，但不够优雅。现在改用Git集中管理，配合Git服务器的匿名访问功能，实现真正的一键恢复。</p>
<h2>架构</h2>
<p><strong>服务器</strong>: Debian虚拟机 (10.10.10.230)
<strong>客户端</strong>: Mac mini (SSH密钥认证)
<strong>备份策略</strong>: Git + Git Daemon匿名只读</p>
<h2>仓库设计</h2>
<p>设计了4个仓库，各司其职：</p>
<table>
<thead>
<tr>
<th>仓库</th>
<th>用途</th>
<th>访问方式</th>
</tr>
</thead>
<tbody><tr>
<td>openclaw-memory</td>
<td>记忆文件、AGENTS.md、MEMORY.md</td>
<td>SSH读写</td>
</tr>
<tr>
<td>openclaw-skills</td>
<td>技能代码（不含node_modules）</td>
<td>SSH读写</td>
</tr>
<tr>
<td>openclaw-dotfiles</td>
<td>.zshrc、Brewfile、SSH公钥</td>
<td>SSH读写</td>
</tr>
<tr>
<td>openclaw-recovery</td>
<td>恢复脚本、私钥、文档</td>
<td><strong>Git匿名只读</strong></td>
</tr>
</tbody></table>
<p>关键点在于<strong>recovery仓库</strong>：它包含SSH私钥和恢复脚本，通过Git Daemon提供匿名只读访问。这意味着重装系统后，无需任何认证就能获取私钥，然后自动配置SSH，再拉取其他仓库。</p>
<h2>服务器配置</h2>
<h3>1. 创建Git用户和仓库</h3>
<pre><code class="language-bash">useradd -m -d /home/git -s /bin/bash git
mkdir -p /srv/git
cd /srv/git

git init --bare openclaw-memory.git
git init --bare openclaw-skills.git
git init --bare openclaw-dotfiles.git
git init --bare openclaw-recovery.git

chown -R git:git /srv/git
</code></pre>
<h3>2. 配置SSH密钥认证</h3>
<pre><code class="language-bash"># Mac上生成密钥
ssh-keygen -t rsa -b 4096 -C &quot;openclaw@macmini&quot;

# 公钥添加到服务器
cat ~/.ssh/id_rsa.pub &gt;&gt; /home/git/.ssh/authorized_keys
</code></pre>
<h3>3. 启用Git Daemon匿名访问</h3>
<pre><code class="language-bash">apt install -y git-daemon-run

cat &gt; /etc/systemd/system/git-daemon.service &lt;&lt; &#39;EOF&#39;
[Unit]
Description=Git Daemon
After=network.target

[Service]
Type=simple
ExecStart=/usr/lib/git-core/git-daemon --reuseaddr --base-path=/srv/git --export-all --verbose
Restart=always
User=git

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable git-daemon
systemctl start git-daemon
</code></pre>
<p>Git Daemon在9418端口提供匿名只读访问，地址格式：<code>git://10.10.10.230/仓库名</code></p>
<h2>一键恢复脚本</h2>
<p>恢复脚本的核心逻辑：</p>
<pre><code class="language-bash">#!/bin/bash
# 1. 匿名获取恢复文件和私钥
git clone git://10.10.10.230/openclaw-recovery.git /tmp/recovery
cd /tmp/recovery

# 2. 部署私钥
mkdir -p ~/.ssh
chmod 700 ~/.ssh
cp id_rsa ~/.ssh/id_rsa
chmod 600 ~/.ssh/id_rsa

# 3. 配置SSH跳过host key检查（内网安全）
cat &gt; ~/.ssh/config &lt;&lt; &#39;EOF&#39;
Host 10.10.10.230
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
    User git
    Port 22
    IdentityFile ~/.ssh/id_rsa
EOF

# 4. 安装Homebrew
/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot;

# 5. 安装Git、Node
brew install git node

# 6. 克隆所有仓库
git clone git@10.10.10.230:/srv/git/openclaw-dotfiles.git /tmp/dotfiles
git clone git@10.10.10.230:/srv/git/openclaw-memory.git ~/.openclaw/workspace
git clone git@10.10.10.230:/srv/git/openclaw-skills.git ~/.openclaw/workspace/skills

# 7. 恢复配置
cp /tmp/dotfiles/.zshrc ~/
cp /tmp/dotfiles/*.pub ~/.ssh/
cd /tmp/dotfiles &amp;&amp; brew bundle install

# 8. 安装OpenClaw
npm install -g openclaw

echo &quot;恢复完成！&quot;
</code></pre>
<p>实际使用时只需两行命令：</p>
<pre><code class="language-bash">git clone git://10.10.10.230/openclaw-recovery.git /tmp/recovery
bash /tmp/recovery/restore.sh
</code></pre>
<p>全程无需手动输入，约10分钟完成。</p>
<h2>日常备份</h2>
<p>日常开发中，变更立即推送：</p>
<pre><code class="language-bash"># 一键备份所有
git clone git://10.10.10.230/openclaw-recovery.git /tmp/r 2&gt;/dev/null
cd /tmp/r &amp;&amp; ./backup-all.sh

# 或手动分别备份
cd ~/.openclaw/workspace &amp;&amp; git add -A &amp;&amp; git commit -m &quot;backup&quot; &amp;&amp; git push
cd ~/.openclaw/workspace/skills &amp;&amp; git add -A &amp;&amp; git commit -m &quot;backup&quot; &amp;&amp; git push
</code></pre>
<h2>安全考量</h2>
<p>这套方案基于内网环境，做了以下权衡：</p>
<ol>
<li><strong>SSH私钥存储在Git仓库中</strong>：通过Git Daemon只读暴露，重装时能自动获取</li>
<li><strong>跳过SSH host key检查</strong>：内网环境，简化配置</li>
<li><strong>node_modules不备份</strong>：体积大，恢复后重新安装</li>
</ol>
<p>如果是公网环境，建议：</p>
<ul>
<li>私钥改用密码管理器（如1Password）保管</li>
<li>使用HTTPS + Token方式认证</li>
<li>启用Git的签名验证</li>
</ul>
<h2>总结</h2>
<p>这套方案实现了真正的&quot;一键重装恢复&quot;：</p>
<ul>
<li><strong>10分钟</strong>：从裸机到完全可用</li>
<li><strong>0干预</strong>：全自动执行，无需手动输入</li>
<li><strong>版本化</strong>：所有配置都有Git历史记录</li>
</ul>
<p>对于经常折腾系统的开发者来说，这是一套实用的备份策略。</p>
<h2>仓库地址</h2>
<pre><code># 匿名只读（恢复用）
git://10.10.10.230/openclaw-recovery.git

# SSH读写（日常使用）
git@10.10.10.230:/srv/git/openclaw-memory.git
git@10.10.10.230:/srv/git/openclaw-skills.git
git@10.10.10.230:/srv/git/openclaw-dotfiles.git
git@10.10.10.230:/srv/git/openclaw-recovery.git
</code></pre>
