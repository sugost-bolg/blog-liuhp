---
title: OpenClaw 备份系统 v2：定时轮转与一键恢复
date: 2026-02-16T06:36:45.878000+08:00
lastmod: 2026-02-16T06:36:45.878000+08:00
draft: false
categories: 
- category-default

tags: []
description: 
slug: openclaw--mlobrx62
aliases: 
- /archives/openclaw--mlobrx62

---

\n# OpenClaw 备份系统 v2：定时轮转与一键恢复\n\n
\n最近重构了 OpenClaw 的备份体系，从原来的文件监听自动备份改为定时轮转架构，实现更可靠的备份策略和更完整的恢复体验。\n\n
\n## 设计思路\n\n
\n旧方案的问题是：\n\n

- 文件监听触发频繁，容易产生过多历史版本\n
- 恢复时不会自动重建定时任务\n
- 配置分散在多个仓库\n

\n新方案的核心是 定时备份 + 单仓标签轮转 + 配置自包含：\n\n

- 一个仓库：`openclaw-backup.git`\n
- 三个标签：`current → backup-1 → backup-2`\n
- 定时触发：每晚 23:00 自动备份\n
- 配置导出：自动保存定时任务到 `.cron-jobs.json`\n

\n## 架构特点\n\n
\n### 1. 极简命令\n\n
\n```\n`backup now       # 立即备份
backup list      # 查看历史版本
backup restore   # 交互式恢复
`\n```\n
\n### 2. 定时轮转\n\n
\n每晚 23:00 自动执行备份，保留最近 3 个历史版本：\n\n
\n```\n`新备份前：  current    backup-1   backup-2
               ↓          ↓          ↓
新备份后：  新内容     原current   原backup-1
                        
(原backup-2 被删除)
`\n```\n
\nGit 标签是轻量级的，只是指针移动，不会复制文件内容。\n\n
\n### 3. 配置自包含\n\n
\n备份时自动导出定时任务配置：\n\n
\n```\n`{
  "jobs": [
    { "name": "系统心跳", "schedule": "0 8 * * *", ... },
    { "name": "Git 备份", "schedule": "0 23 * * *", ... }
  ]
}
`\n```\n
\n恢复时自动读取 `.cron-jobs.json` 重建所有定时任务。\n\n
\n### 4. 零依赖恢复\n\n
\n重装系统后只需一行命令：\n\n
\n```\n`curl http://10.10.10.230:8080/restore.sh | bash
`\n```\n
\n全程自动完成：\n\n

- 安装 Homebrew/Git/Node\n
- 恢复 SSH 密钥\n
- 克隆 workspace（含技能+记忆+脚本）\n
- 安装 OpenClaw\n
- 重建所有定时任务\n

\n无需预装任何依赖，甚至不需要手动配置。\n\n
\n## 技术实现\n\n
\n### Git 服务器架构\n\n
\n```\n`10.10.10.230
├── /srv/git/openclaw-backup.git    # 裸仓库
├── git daemon (9418端口)           # 匿名克隆
└── busybox httpd (8080端口)        # 提供 restore.sh
`\n```\n
\n### 恢复流程\n\n
\n```\n`# 1. 下载恢复脚本
curl -o /tmp/restore.sh http://10.10.10.230:8080/restore.sh

# 2. 交互式选择版本
bash /tmp/restore.sh
# [0] current   - 2026-02-17 (最新)
# [1] backup-1  - 2026-02-16
# [2] backup-2  - 2026-02-15

# 3. 确认重建定时任务
# 发现 .cron-jobs.json，是否重建定时任务？ [Y/n]
`\n```\n
\n### 版本轮转逻辑\n\n
\n```\n`# 推送新备份
git push origin main --force

# 标签轮转
git tag -d backup-2 2>/dev/null
git tag backup-2 backup-1
git tag backup-1 current
git tag -f current main

# 推送标签
git push origin --tags --force
`\n```\n
\n## 部署流程\n\n
\n### 首次部署（Git 服务器）\n\n
\n```\n`# 1. 创建裸仓库
ssh root@10.10.10.230
mkdir -p /srv/git/openclaw-backup.git
cd /srv/git/openclaw-backup.git
git init --bare

# 2. 启动 Git Daemon
git daemon --reuseaddr --base-path=/srv/git/ /srv/git/

# 3. 启动 HTTP 服务（提供 restore.sh）
busybox httpd -p 8080 -h /srv/www
`\n```\n
\n### 客户端配置\n\n
\n```\n`# 1. 配置 Git 远程
git remote add backup git@10.10.10.230:/srv/git/openclaw-backup.git

# 2. 首次备份
backup now

# 3. 定时任务已自动创建（每晚 23:00）
`\n```\n
\n## 恢复实战\n\n
\n### 场景：Mac 重装后恢复\n\n
\n```\n`# 1. 执行恢复脚本
curl http://10.10.10.230:8080/restore.sh | bash

# 2. 选择版本（示例选 current）
> 0

# 3. 重建定时任务
> Y

# 4. 完成
恢复完成！请重新加载 shell 配置：
source ~/.zshrc
`\n```\n
\n约 10-15 分钟完成全部恢复。\n\n
\n## 对比旧方案\n\n
\n||\n||\n||\n||\n||\n||\n||\n||\n\n
\n## 适用场景\n\n
\n这套系统适合：\n\n

- 个人工作站备份\n
- 开发环境同步\n
- 配置即代码（Dotfiles）\n
- 需要快速重装恢复的场景\n

\n不适合：\n\n

- 大型项目代码管理（用 Git 原生工作流）\n
- 需要审计日志的企业环境\n
- 多人协作频繁的场景\n

\n## 后续优化\n\n

- 支持备份到云端（S3/阿里云OSS）\n
- Web 界面查看历史版本\n
- 增量备份（目前是全量）\n
- 备份加密\n
- 备份失败告警\n

---

\n备份这件事，越简单越容易坚持。新系统运行两周，确实比原来省心多了。\n\n
\n快速参考：\n\n
\n```\n`backup now        # 立即备份
backup list       # 查看版本
backup restore    # 交互式恢复
`\n```\n
\n