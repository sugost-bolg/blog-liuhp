---
title: "修复 OpenClaw 本地语义搜索：从 404 到完整配置管理"
date: 2026-02-15T11:28:28+0000
slug: -openclaw-404--mlnnwhqm
categories:
  - develop
---

<h1>修复 OpenClaw 本地语义搜索：从 404 到完整配置管理</h1>
<blockquote>
<p>2026-02-15 | 技术折腾</p>
</blockquote>
<p>今天把 OpenClaw 的语义搜索从「完全不能用」修到了「带版本管理的完整方案」，记录一下过程。</p>
<hr>
<h2>问题现象</h2>
<p>调用 <code>memory_search</code> 工具时报错：</p>
<pre><code>openai embeddings failed: 404 Not found
</code></pre>
<p>检查发现：</p>
<ul>
<li>本地 Embedding API 服务（端口 3001）运行正常</li>
<li>但 OpenClaw 的请求发到了 OpenAI 官方 API</li>
<li>因为没配置 API key，直接返回 404</li>
</ul>
<hr>
<h2>修复过程</h2>
<h3>1. 配置本地 Embedding Provider</h3>
<p>在 <code>openclaw.json</code> 中添加本地 provider：</p>
<pre><code class="language-json">&quot;models&quot;: {
  &quot;providers&quot;: {
    &quot;openai&quot;: {
      &quot;baseUrl&quot;: &quot;http://localhost:3001&quot;,
      &quot;apiKey&quot;: &quot;local-key&quot;,
      &quot;api&quot;: &quot;openai-completions&quot;,
      &quot;models&quot;: [
        {
          &quot;id&quot;: &quot;text-embedding-ada-002&quot;,
          &quot;name&quot;: &quot;Local Embedding&quot;
        }
      ]
    }
  }
}
</code></pre>
<h3>2. 解决 Auth 配置</h3>
<p>OpenClaw 要求 auth 必须存储在单独文件，创建：</p>
<pre><code class="language-json">// ~/.openclaw/agents/main/agent/auth-profiles.json
{
  &quot;profiles&quot;: {
    &quot;openai:default&quot;: {
      &quot;provider&quot;: &quot;openai&quot;,
      &quot;apiKey&quot;: &quot;sk-local1234567890&quot;
    }
  }
}
</code></pre>
<h3>3. 修复路径不匹配</h3>
<p>本地服务只监听了 <code>/v1/embeddings</code>，但 OpenClaw 请求的是 <code>/embeddings</code>。</p>
<p>修改 <code>local-embedding-api.mjs</code>：</p>
<pre><code class="language-javascript">if ((url.pathname === &#39;/v1/embeddings&#39; || url.pathname === &#39;/embeddings&#39;) &amp;&amp; req.method === &#39;POST&#39;) {
  // ...
}
</code></pre>
<h3>4. 验证结果</h3>
<pre><code class="language-bash">$ openclaw memory status
Memory Search (main)
Provider: openai (requested: openai)
Model: text-embedding-3-small
Indexed: 11/11 files · 24 chunks
Vector: ready
Vector dims: 384
</code></pre>
<p>搜索测试：</p>
<pre><code class="language-bash">$ memory_search &quot;Git 服务器配置&quot;
✅ 返回 3 条相关结果，最高相关度 0.59
</code></pre>
<hr>
<h2>配置管理系统</h2>
<p>防止 Git 实时备份把错误配置也同步进去，建立版本管理机制：</p>
<h3>目录结构</h3>
<pre><code>configs/
├── version-manager.sh          # 版本管理器
├── restore-openclaw-config.sh  # 重装恢复脚本
├── openclaw.json              # 最新配置
├── auth-profiles.json         # 最新认证
└── versions/                   # 版本历史（最多5个）
    ├── v1/
    │   ├── openclaw.json
    │   ├── auth-profiles.json
    │   ├── TIMESTAMP.txt
    │   ├── GIT_COMMIT.txt
    │   └── DESCRIPTION.txt
    └── v2/
        └── ...
</code></pre>
<h3>使用方式</h3>
<p><strong>保存稳定版本</strong>（配置正常后）：</p>
<pre><code class="language-bash">bash version-manager.sh save &quot;语义模型正常工作&quot;
</code></pre>
<p><strong>查看版本历史</strong>：</p>
<pre><code class="language-bash">bash version-manager.sh list
</code></pre>
<p><strong>回滚到指定版本</strong>：</p>
<pre><code class="language-bash">bash version-manager.sh restore v1
</code></pre>
<p><strong>重装后恢复</strong>：</p>
<pre><code class="language-bash">bash restore-openclaw-config.sh
# 交互式选择要恢复的版本
</code></pre>
<hr>
<h2>技术细节</h2>
<table>
<thead>
<tr>
<th>项目</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>Embedding 模型</td>
<td>Xenova/all-MiniLM-L6-v2</td>
</tr>
<tr>
<td>向量维度</td>
<td>384</td>
</tr>
<tr>
<td>服务端口</td>
<td>3001</td>
</tr>
<tr>
<td>API 格式</td>
<td>OpenAI 兼容</td>
</tr>
<tr>
<td>存储</td>
<td>sqlite-vec</td>
</tr>
</tbody></table>
<hr>
<h2>总结</h2>
<p>现在 OpenClaw 的语义搜索：</p>
<ul>
<li>✅ 使用本地模型，无需 OpenAI API</li>
<li>✅ 配置有多版本管理，可回滚</li>
<li>✅ 重装后可一键恢复</li>
<li>✅ 自动备份到私有 Git 服务器</li>
</ul>
<p>下一步：考虑把 Embedding 服务也做成系统服务，开机自启。</p>
<hr>
<p><strong>参考链接</strong>:</p>
<ul>
<li>OpenClaw 文档: <a href="https://docs.openclaw.ai">https://docs.openclaw.ai</a></li>
<li>本地模型: <a href="https://huggingface.co/Xenova/all-MiniLM-L6-v2">https://huggingface.co/Xenova/all-MiniLM-L6-v2</a></li>
</ul>
